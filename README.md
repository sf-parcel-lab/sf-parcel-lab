# SF Parcel Explorer - LLM Chatbot Integration

A San Francisco parcel exploration application with an integrated AI chatbot that allows users to query parcel data using natural language. The chatbot converts user queries into MongoDB queries and displays results on an interactive map.

## 🚀 Features

- **🤖 AI-Powered Chatbot**: Natural language queries for parcel data
- **🗺️ Interactive Map**: Visual display of parcel results with zoning colors
- **🔍 Query Transparency**: See the MongoDB query generated by the AI
- **📱 Responsive Design**: Works on desktop and mobile devices
- **⚡ Real-time Processing**: Instant results from LLM backend
- **🎨 Modern UI**: Clean, intuitive interface with chat-like experience

## 🏗️ Architecture

- **Frontend**: React.js with Leaflet maps (Port 3000)
- **Backend**: Node.js/Express with LangChain (Port 3001)
- **Database**: MongoDB (Cloud hosted)
- **AI**: OpenAI GPT-4 via LangChain

## 📦 Installation

### Prerequisites
- Node.js (v16 or higher)
- npm or yarn
- OpenAI API key
- MongoDB connection string

### Backend Setup

1. **Navigate to backend directory:**
```bash
cd backend
```

2. **Install dependencies:**
```bash
npm install
```

3. **Install LLM dependencies:**
```bash
npm install langchain @langchain/openai
```

4. **Set up environment variables:**
```bash
node setup-env.js
```

5. **Edit `.env` file and add your OpenAI API key:**
```env
OPENAI_API_KEY=your_actual_openai_api_key_here
```

6. **Start the backend server:**
```bash
npm start
```

### Frontend Setup

1. **Navigate to frontend directory:**
```bash
cd Frontend/frontend
```

2. **Install dependencies:**
```bash
npm install
```

3. **Start the frontend server:**
```bash
npm run dev
```

## 🔧 Backend Implementation

### Core Files

#### `backend/src/server.js`
Main server file with LLM chatbot endpoints.

#### Key Endpoints

**Health Check:**
```javascript
app.get('/api/health', (req, res) => {
  res.json({ status: 'ok' });
});
```

**LLM Chatbot Query:**
```javascript
app.post('/api/query', async (req, res) => {
  try {
    const { message } = req.body;
    
    if (!message) {
      return res.status(400).json({ error: 'Message is required' });
    }

    // Generate MongoDB query using LLM
    const messages = [
      new SystemMessage(SYSTEM_PROMPT),
      new HumanMessage(message)
    ];
    
    const response = await llm.invoke(messages);
    const mongoQuery = JSON.parse(response.content);
    
    // Execute MongoDB query
    const results = await collection.find(mongoQuery, { projection: { _id: 0 } }).limit(50).toArray();
    
    res.json({
      data: results,
      query_used: mongoQuery,
      message: message
    });
    
  } catch (error) {
    console.error('Query error:', error);
    res.status(500).json({ 
      error: 'Query failed', 
      details: error.message 
    });
  }
});
```

### Dependencies
```json
{
  "dependencies": {
    "@langchain/openai": "^0.6.3",
    "langchain": "^0.3.30",
    "express": "^4.19.2",
    "mongodb": "^6.18.0",
    "dotenv": "^16.4.5"
  }
}
```

### Environment Variables
```env
# OpenAI API Key
OPENAI_API_KEY=your_openai_api_key_here

# MongoDB Connection
MONGODB_URI=mongodb+srv://kodjmail:Qc8oBlspgJIEibtz@cluster0.lou1990.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0
MONGODB_DB=sf_parcels

# Server Port
PORT=3001
```

### LLM System Prompt
```javascript
const SYSTEM_PROMPT = `
You are a helpful assistant for a San Francisco city parcel explorer.

Your job is to extract **structured MongoDB query filters** from user input.
The user will ask natural-language questions about land parcels in San Francisco, such as:
- Zoning type
- Neighborhood or district
- Use case (residential, mixed-use, commercial)
- Supervisor district
- Block or street

Extract only relevant filters. Output a Python dict with keys and values directly usable in MongoDB queries.

If a location like "Ingleside" or "South of Market" is mentioned, map it to 'planning_district' or 'analysis_neighborhood'.
If the user says "two-family home", map to "zoning_code: RH-2".
If the user says "mixed use", map to "zoning_code: MUG".

Only output JSON, no extra text.
`;
```

### LangChain Setup
```javascript
const { ChatOpenAI } = require('@langchain/openai');
const { HumanMessage, SystemMessage } = require('@langchain/core/messages');

const llm = new ChatOpenAI({
  modelName: "gpt-4",
  temperature: 0,
  openAIApiKey: process.env.OPENAI_API_KEY
});
```

### MongoDB Connection
```javascript
const { MongoClient } = require('mongodb');

const client = new MongoClient(process.env.MONGODB_URI || 'mongodb://localhost:27017');
const db = client.db('sf_parcels');
const collection = db.collection('parcels');
```

## 🎨 Frontend Implementation

### Core Files

#### `Frontend/frontend/src/components/ParcelMap.jsx`
Main component with integrated chatbot functionality.

#### Key Features Added

**State Management:**
```javascript
// Chatbot state
const [messages, setMessages] = useState([]);
const [isChatExpanded, setIsChatExpanded] = useState(false);
const messagesEndRef = useRef(null);

// API endpoints
const API_BASE = 'http://localhost:3001';
const LLM_QUERY_ENDPOINT = `${API_BASE}/api/query`;
```

**LLM Query Processing:**
```javascript
const processLLMQuery = async (query) => {
  try {
    setSearchLoading(true);
    setSearchError(null);
    
    const response = await fetch(LLM_QUERY_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: query })
    });
    
    if (!response.ok) {
      throw new Error(`LLM query failed: ${response.status} ${response.statusText}`);
    }
    
    const data = await response.json();
    return data;
    
  } catch (err) {
    console.error('Error processing LLM query:', err);
    setSearchError('⚠️ Could not interpret your query');
    return null;
  } finally {
    setSearchLoading(false);
  }
};
```

**Chat Message Handling:**
```javascript
const handleChatMessage = async (message) => {
  if (!message.trim()) return;

  const userMessage = {
    id: Date.now(),
    text: message,
    sender: 'user',
    timestamp: new Date().toLocaleTimeString()
  };

  setMessages(prev => [...prev, userMessage]);
  setSearchQuery('');
  setSearchLoading(true);
  setSearchError(null);

  try {
    const data = await processLLMQuery(message);
    
    if (data && data.data) {
      const botMessage = {
        id: Date.now() + 1,
        text: `Found ${data.data.length} parcels matching your query.`,
        sender: 'bot',
        timestamp: new Date().toLocaleTimeString(),
        data: data.data,
        queryUsed: data.query_used
      };

      setMessages(prev => [...prev, botMessage]);

      // Display results on map
      if (data.data.length > 0) {
        const geoJsonData = {
          type: "FeatureCollection",
          features: data.data.map(parcel => ({
            type: "Feature",
            geometry: parcel.geometry,
            properties: parcel.properties || parcel
          }))
        };
        
        setParcelData(geoJsonData);
        setCurrentFilters(data.query_used);
        setDebugInfo(`Found ${data.data.length} parcels matching your query`);
      } else {
        setError('⚠️ No parcels matched your query');
        setParcelData(null);
      }
    }
  } catch (err) {
    // Error handling...
  } finally {
    setSearchLoading(false);
  }
};
```

#### `Frontend/frontend/src/components/ParcelMap.css`
Styling for the chatbot interface.

**Key CSS Classes:**
```css
/* Chat Messages */
.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  background: #f8f9fa;
  border-top: 1px solid #e1e5e9;
  max-height: 300px;
}

/* Message Styles */
.message.user .message-content {
  background: #4A90E2;
  color: white;
  border-bottom-right-radius: 4px;
}

.message.bot .message-content {
  background: white;
  color: #333;
  border: 1px solid #e1e5e9;
  border-bottom-left-radius: 4px;
}

/* Loading Animation */
.loading-dots {
  display: flex;
  gap: 4px;
  justify-content: center;
  padding: 8px;
}

/* Query Details */
.query-details pre {
  background: #f5f5f5;
  padding: 8px;
  border-radius: 4px;
  margin-top: 8px;
  font-size: 11px;
  overflow-x: auto;
  white-space: pre-wrap;
  word-break: break-word;
}
```

## 🧪 Testing

### Backend API Testing

**Health Check:**
```bash
curl http://localhost:3001/api/health
```

**LLM Query Test:**
```bash
curl -X POST http://localhost:3001/api/query \
  -H "Content-Type: application/json" \
  -d '{"message": "Show me residential properties in Ingleside"}'
```

### Frontend Testing

1. **Open browser**: http://localhost:3000
2. **Test queries**:
   - "Show me residential properties in Ingleside"
   - "Find commercial properties"
   - "Two-family homes in South of Market"
3. **Test features**:
   - Chat expansion/collapse (💬 button)
   - Message history
   - Query transparency
   - Map results display
   - Error handling

## 📁 File Structure

```
gitt/
├── backend/
│   ├── src/
│   │   └── server.js          # Main server with LLM endpoints
│   ├── package.json           # Dependencies
│   ├── .env                   # Environment variables
│   └── setup-env.js          # Environment setup script
└── Frontend/
    └── frontend/
        ├── src/
        │   ├── components/
        │   │   ├── ParcelMap.jsx    # Main component with chatbot
        │   │   └── ParcelMap.css    # Chatbot styling
        │   ├── App.jsx              # App wrapper
        │   └── main.jsx             # Entry point
        └── package.json
```

## 🎯 Features Implemented

### Backend
- ✅ Natural Language to MongoDB Query Conversion
- ✅ Real-time LLM Processing
- ✅ Error Handling & Validation
- ✅ Query Transparency
- ✅ MongoDB Integration
- ✅ CORS Support for Frontend
- ✅ Environment Variable Management

### Frontend
- ✅ Search Bar Transformation to Chat Interface
- ✅ Message History with User/Bot Distinction
- ✅ Query Transparency (Shows MongoDB Query)
- ✅ Map Integration with Results
- ✅ Loading States and Visual Feedback
- ✅ Error Handling with User-Friendly Messages
- ✅ Auto-scroll to Latest Messages
- ✅ Responsive Design for Mobile/Desktop
- ✅ Clear Functionality to Reset Search
- ✅ Welcome Message with Instructions

## 🔄 Rebuild Instructions

### Backend Rebuild
1. Install dependencies: `npm install langchain @langchain/openai express mongodb dotenv`
2. Set up environment: Run `node setup-env.js` and add OpenAI API key
3. Start server: `npm start` or `node src/server.js`
4. Test endpoints using the testing commands above

### Frontend Rebuild
1. Update ParcelMap.jsx with chatbot state and functions
2. Add CSS classes for chat interface styling
3. Update App.jsx to import ParcelMap component
4. Set API endpoints to point to backend (port 3001)
5. Test chat functionality with backend running

## 🚀 Usage

1. **Start both servers**:
   - Backend: `cd backend && npm start`
   - Frontend: `cd Frontend/frontend && npm run dev`

2. **Open application**: http://localhost:3000

3. **Use the chatbot**:
   - Type natural language queries in the search bar
   - Click 💬 to expand chat history
   - View results on the map
   - See the MongoDB query used (click "View Query Used")

4. **Example queries**:
   - "Show me residential properties in Ingleside"
   - "Find commercial properties in South of Market"
   - "Two-family homes"
   - "Mixed-use buildings"

## 🤝 Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Test thoroughly
5. Submit a pull request

## 📄 License

This project is licensed under the MIT License.

## 🆘 Support

For issues or questions:
1. Check the testing section above
2. Verify environment variables are set correctly
3. Ensure both servers are running
4. Check browser console for errors
5. Verify OpenAI API key is valid and has credits

---

**Built with ❤️ for SF Parcel Exploration** 